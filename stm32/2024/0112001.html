<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>任务的定义与任务切换的实现 | 博客</title>
    <meta name="generator" content="VuePress 1.9.7">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.7.1/katex.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/github-markdown-css/2.10.0/github-markdown.min.css">
    <meta name="description" content="">
    
    <link rel="preload" href="/blog/assets/css/0.styles.c2d7d718.css" as="style"><link rel="preload" href="/blog/assets/js/app.adc2faba.js" as="script"><link rel="preload" href="/blog/assets/js/6.c7879e8b.js" as="script"><link rel="preload" href="/blog/assets/js/1.6ba5f926.js" as="script"><link rel="preload" href="/blog/assets/js/62.4248028d.js" as="script"><link rel="prefetch" href="/blog/assets/js/10.fe7787a3.js"><link rel="prefetch" href="/blog/assets/js/100.fb062556.js"><link rel="prefetch" href="/blog/assets/js/101.fcbc1f90.js"><link rel="prefetch" href="/blog/assets/js/102.ac776d23.js"><link rel="prefetch" href="/blog/assets/js/103.a745b219.js"><link rel="prefetch" href="/blog/assets/js/104.83df1dc5.js"><link rel="prefetch" href="/blog/assets/js/105.4fe13a23.js"><link rel="prefetch" href="/blog/assets/js/106.a877e389.js"><link rel="prefetch" href="/blog/assets/js/107.a854feaa.js"><link rel="prefetch" href="/blog/assets/js/108.4c6eac1e.js"><link rel="prefetch" href="/blog/assets/js/109.30988643.js"><link rel="prefetch" href="/blog/assets/js/11.7b4ec8e0.js"><link rel="prefetch" href="/blog/assets/js/110.39f637f1.js"><link rel="prefetch" href="/blog/assets/js/111.9d749e3b.js"><link rel="prefetch" href="/blog/assets/js/112.098636e2.js"><link rel="prefetch" href="/blog/assets/js/113.7889c565.js"><link rel="prefetch" href="/blog/assets/js/114.2e50a91d.js"><link rel="prefetch" href="/blog/assets/js/115.3ec62f37.js"><link rel="prefetch" href="/blog/assets/js/116.f15e8be2.js"><link rel="prefetch" href="/blog/assets/js/12.126a4f02.js"><link rel="prefetch" href="/blog/assets/js/13.38669150.js"><link rel="prefetch" href="/blog/assets/js/14.46e810b6.js"><link rel="prefetch" href="/blog/assets/js/15.78b28d3d.js"><link rel="prefetch" href="/blog/assets/js/16.81416521.js"><link rel="prefetch" href="/blog/assets/js/17.8dc851f5.js"><link rel="prefetch" href="/blog/assets/js/18.8b0a903d.js"><link rel="prefetch" href="/blog/assets/js/19.eb149ccd.js"><link rel="prefetch" href="/blog/assets/js/20.932706c6.js"><link rel="prefetch" href="/blog/assets/js/21.16ef4c6f.js"><link rel="prefetch" href="/blog/assets/js/22.2fa9a7b7.js"><link rel="prefetch" href="/blog/assets/js/23.d4960d39.js"><link rel="prefetch" href="/blog/assets/js/24.39307edb.js"><link rel="prefetch" href="/blog/assets/js/25.e2d6bc7c.js"><link rel="prefetch" href="/blog/assets/js/26.6db1add7.js"><link rel="prefetch" href="/blog/assets/js/27.d9b88a60.js"><link rel="prefetch" href="/blog/assets/js/28.1a9e8d71.js"><link rel="prefetch" href="/blog/assets/js/29.ad13614d.js"><link rel="prefetch" href="/blog/assets/js/3.0a5dd309.js"><link rel="prefetch" href="/blog/assets/js/30.e0295e00.js"><link rel="prefetch" href="/blog/assets/js/31.89be1c6b.js"><link rel="prefetch" href="/blog/assets/js/32.aeebd2a4.js"><link rel="prefetch" href="/blog/assets/js/33.da9112ed.js"><link rel="prefetch" href="/blog/assets/js/34.0a1d2225.js"><link rel="prefetch" href="/blog/assets/js/35.a61a072f.js"><link rel="prefetch" href="/blog/assets/js/36.a55c29c6.js"><link rel="prefetch" href="/blog/assets/js/37.a3b42192.js"><link rel="prefetch" href="/blog/assets/js/38.a2b6c6fe.js"><link rel="prefetch" href="/blog/assets/js/39.d5275c88.js"><link rel="prefetch" href="/blog/assets/js/4.3d05c3e4.js"><link rel="prefetch" href="/blog/assets/js/40.b516d5e6.js"><link rel="prefetch" href="/blog/assets/js/41.e9122d30.js"><link rel="prefetch" href="/blog/assets/js/42.80f6f853.js"><link rel="prefetch" href="/blog/assets/js/43.a6770ce4.js"><link rel="prefetch" href="/blog/assets/js/44.940ee877.js"><link rel="prefetch" href="/blog/assets/js/45.767efffa.js"><link rel="prefetch" href="/blog/assets/js/46.a0db4406.js"><link rel="prefetch" href="/blog/assets/js/47.e776b4fb.js"><link rel="prefetch" href="/blog/assets/js/48.62c2b8cb.js"><link rel="prefetch" href="/blog/assets/js/49.60b0dfa2.js"><link rel="prefetch" href="/blog/assets/js/5.f3af935d.js"><link rel="prefetch" href="/blog/assets/js/50.14c4a6ee.js"><link rel="prefetch" href="/blog/assets/js/51.fb295fef.js"><link rel="prefetch" href="/blog/assets/js/52.3da8763c.js"><link rel="prefetch" href="/blog/assets/js/53.4d251dc3.js"><link rel="prefetch" href="/blog/assets/js/54.22d0bc7a.js"><link rel="prefetch" href="/blog/assets/js/55.83f6702e.js"><link rel="prefetch" href="/blog/assets/js/56.3f8712b5.js"><link rel="prefetch" href="/blog/assets/js/57.2c746969.js"><link rel="prefetch" href="/blog/assets/js/58.43894d05.js"><link rel="prefetch" href="/blog/assets/js/59.9652b9cb.js"><link rel="prefetch" href="/blog/assets/js/60.fce7f568.js"><link rel="prefetch" href="/blog/assets/js/61.b83d6958.js"><link rel="prefetch" href="/blog/assets/js/63.68cf9169.js"><link rel="prefetch" href="/blog/assets/js/64.071f99d5.js"><link rel="prefetch" href="/blog/assets/js/65.57cae4d8.js"><link rel="prefetch" href="/blog/assets/js/66.aaf39db5.js"><link rel="prefetch" href="/blog/assets/js/67.94b66cd3.js"><link rel="prefetch" href="/blog/assets/js/68.f59efbab.js"><link rel="prefetch" href="/blog/assets/js/69.a54cacad.js"><link rel="prefetch" href="/blog/assets/js/7.168cd95a.js"><link rel="prefetch" href="/blog/assets/js/70.125fb2b9.js"><link rel="prefetch" href="/blog/assets/js/71.d4d2c0b2.js"><link rel="prefetch" href="/blog/assets/js/72.c83b1c30.js"><link rel="prefetch" href="/blog/assets/js/73.3882cfc5.js"><link rel="prefetch" href="/blog/assets/js/74.35e43a00.js"><link rel="prefetch" href="/blog/assets/js/75.226547a5.js"><link rel="prefetch" href="/blog/assets/js/76.a5da7ea1.js"><link rel="prefetch" href="/blog/assets/js/77.1c717162.js"><link rel="prefetch" href="/blog/assets/js/78.4b6da02c.js"><link rel="prefetch" href="/blog/assets/js/79.8e6ac326.js"><link rel="prefetch" href="/blog/assets/js/8.8c5d4817.js"><link rel="prefetch" href="/blog/assets/js/80.484686e1.js"><link rel="prefetch" href="/blog/assets/js/81.79994cce.js"><link rel="prefetch" href="/blog/assets/js/82.87043f88.js"><link rel="prefetch" href="/blog/assets/js/83.f63b123c.js"><link rel="prefetch" href="/blog/assets/js/84.84cbb039.js"><link rel="prefetch" href="/blog/assets/js/85.3b893911.js"><link rel="prefetch" href="/blog/assets/js/86.cd47b309.js"><link rel="prefetch" href="/blog/assets/js/87.6877aefa.js"><link rel="prefetch" href="/blog/assets/js/88.1e269399.js"><link rel="prefetch" href="/blog/assets/js/89.d0e9f998.js"><link rel="prefetch" href="/blog/assets/js/9.9bc781e0.js"><link rel="prefetch" href="/blog/assets/js/90.58d7a4df.js"><link rel="prefetch" href="/blog/assets/js/91.2df7ef87.js"><link rel="prefetch" href="/blog/assets/js/92.45b90ddb.js"><link rel="prefetch" href="/blog/assets/js/93.4aa2dcae.js"><link rel="prefetch" href="/blog/assets/js/94.2a5498eb.js"><link rel="prefetch" href="/blog/assets/js/95.a7d160da.js"><link rel="prefetch" href="/blog/assets/js/96.228b0e13.js"><link rel="prefetch" href="/blog/assets/js/97.4d991c12.js"><link rel="prefetch" href="/blog/assets/js/98.a306974f.js"><link rel="prefetch" href="/blog/assets/js/99.d63c41b3.js">
    <link rel="stylesheet" href="/blog/assets/css/0.styles.c2d7d718.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container no-sidebar" data-v-5bb33761><div data-v-5bb33761><div class="password-shadow password-wrapper-out" style="display:none;" data-v-59e6cb88 data-v-5bb33761 data-v-5bb33761><h3 class="title" data-v-59e6cb88>博客</h3> <p class="description" data-v-59e6cb88></p> <label id="box" class="inputBox" data-v-59e6cb88><input type="password" value="" data-v-59e6cb88> <span data-v-59e6cb88>Konck! Knock!</span> <button data-v-59e6cb88>OK</button></label> <div class="footer" data-v-59e6cb88><span data-v-59e6cb88><i class="iconfont reco-theme" data-v-59e6cb88></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-59e6cb88>vuePress-theme-reco</a></span> <span data-v-59e6cb88><i class="iconfont reco-copyright" data-v-59e6cb88></i> <a data-v-59e6cb88><span data-v-59e6cb88>土豆</span>
          
        <span data-v-59e6cb88>2021 - </span>
        2024
      </a></span></div></div> <div class="hide" data-v-5bb33761><header class="navbar" data-v-5bb33761><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/blog/" class="home-link router-link-active"><!----> <span class="site-name">博客</span></a> <div class="links"><div class="color-picker"><a class="color-button"><i class="iconfont reco-color"></i></a> <div class="color-picker-menu" style="display:none;"><div class="mode-options"><h4 class="title">Choose mode</h4> <ul class="color-mode-options"><li class="dark">dark</li><li class="auto active">auto</li><li class="light">light</li></ul></div></div></div> <div class="search-box"><i class="iconfont reco-search"></i> <input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/blog/" class="nav-link"><i class="iconfont reco-home"></i>
  home
</a></div><div class="nav-item"><a href="/blog/other/2022/0929001.html" class="nav-link"><i class="iconfont reco-other"></i>
  软件
</a></div><div class="nav-item"><a href="https://github.com/zhoubin-datareachable" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="iconfont reco-github"></i>
  github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="https://support.qq.com/product/435903" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="iconfont reco-suggestion"></i>
  留言板
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="/blog/timeline/" class="nav-link"><i class="iconfont reco-date"></i>
  TimeLine
</a></div> <!----></nav></div></header> <div class="sidebar-mask" data-v-5bb33761></div> <aside class="sidebar" data-v-5bb33761><div class="personal-info-wrapper" data-v-1fad0c41 data-v-5bb33761><img src="/blog/avatar.jpg" alt="author-avatar" class="personal-img" data-v-1fad0c41> <h3 class="name" data-v-1fad0c41>
    土豆
  </h3> <div class="num" data-v-1fad0c41><div data-v-1fad0c41><h3 data-v-1fad0c41>105</h3> <h6 data-v-1fad0c41>文章</h6></div> <div data-v-1fad0c41><h3 data-v-1fad0c41>32</h3> <h6 data-v-1fad0c41>标签</h6></div></div> <ul class="social-links" data-v-1fad0c41></ul> <hr data-v-1fad0c41></div> <nav class="nav-links"><div class="nav-item"><a href="/blog/" class="nav-link"><i class="iconfont reco-home"></i>
  home
</a></div><div class="nav-item"><a href="/blog/other/2022/0929001.html" class="nav-link"><i class="iconfont reco-other"></i>
  软件
</a></div><div class="nav-item"><a href="https://github.com/zhoubin-datareachable" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="iconfont reco-github"></i>
  github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="https://support.qq.com/product/435903" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="iconfont reco-suggestion"></i>
  留言板
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="/blog/timeline/" class="nav-link"><i class="iconfont reco-date"></i>
  TimeLine
</a></div> <!----></nav> <!----> </aside> <div class="password-shadow password-wrapper-in" style="display:none;" data-v-59e6cb88 data-v-5bb33761><h3 class="title" data-v-59e6cb88>任务的定义与任务切换的实现</h3> <!----> <label id="box" class="inputBox" data-v-59e6cb88><input type="password" value="" data-v-59e6cb88> <span data-v-59e6cb88>Konck! Knock!</span> <button data-v-59e6cb88>OK</button></label> <div class="footer" data-v-59e6cb88><span data-v-59e6cb88><i class="iconfont reco-theme" data-v-59e6cb88></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-59e6cb88>vuePress-theme-reco</a></span> <span data-v-59e6cb88><i class="iconfont reco-copyright" data-v-59e6cb88></i> <a data-v-59e6cb88><span data-v-59e6cb88>土豆</span>
          
        <span data-v-59e6cb88>2021 - </span>
        2024
      </a></span></div></div> <div data-v-5bb33761><div data-v-5bb33761><main class="page"><section style="display:;"><div class="page-title"><h1 class="title">任务的定义与任务切换的实现</h1> <div data-v-8a445198><i class="iconfont reco-account" data-v-8a445198><span data-v-8a445198>土豆</span></i> <i class="iconfont reco-date" data-v-8a445198><span data-v-8a445198>2024/1/12</span></i> <!----> <i class="tags iconfont reco-tag" data-v-8a445198><span class="tag-item" data-v-8a445198>stm32</span></i></div></div> <div class="theme-reco-content content__default"><h2 id="创建任务"><a href="#创建任务" class="header-anchor">#</a> 创建任务</h2> <h3 id="_1-定义任务栈"><a href="#_1-定义任务栈" class="header-anchor">#</a> 1.定义任务栈</h3> <p><code>cpu.h</code>中的数据定义</p> <div class="language-c extra-class"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">CPU_H</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">CPU_H</span></span>

<span class="token keyword">typedef</span>  <span class="token keyword">unsigned</span>  <span class="token keyword">short</span>       CPU_INT16U<span class="token punctuation">;</span>
<span class="token keyword">typedef</span>  <span class="token keyword">unsigned</span>  <span class="token keyword">int</span>         CPU_INT32U<span class="token punctuation">;</span>
<span class="token keyword">typedef</span>  <span class="token keyword">unsigned</span>  <span class="token keyword">char</span>        CPU_INT08U<span class="token punctuation">;</span>

<span class="token keyword">typedef</span>  CPU_INT32U  CPU_ADDR<span class="token punctuation">;</span>

<span class="token comment">/* 堆栈数据类型重定义 */</span>
<span class="token keyword">typedef</span>  CPU_INT32U             CPU_STK<span class="token punctuation">;</span>
<span class="token keyword">typedef</span>  CPU_ADDR               CPU_STK_SIZE<span class="token punctuation">;</span>

<span class="token keyword">typedef</span>  <span class="token keyword">volatile</span>  CPU_INT32U  CPU_REG32<span class="token punctuation">;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* CPU_H */</span></span>
</code></pre></div><p><code>app.c</code> 中定义任务栈</p> <div class="language-c extra-class"><pre class="language-c"><code><span class="token comment">// 设置任务栈大小为字节</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span>  <span class="token macro-name">TASK1_STK_SIZE</span>       <span class="token expression"><span class="token number">128</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span>  <span class="token macro-name">TASK2_STK_SIZE</span>       <span class="token expression"><span class="token number">128</span></span></span>

<span class="token comment">// 定义任务栈</span>
<span class="token keyword">static</span>   CPU_STK   Task1Stk<span class="token punctuation">[</span>TASK1_STK_SIZE<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">static</span>   CPU_STK   Task2Stk<span class="token punctuation">[</span>TASK2_STK_SIZE<span class="token punctuation">]</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="_2-定义任务函数"><a href="#_2-定义任务函数" class="header-anchor">#</a> 2.定义任务函数</h3> <p><code>app.c</code>中定义任务函数,flag定义为了在逻辑分析仪中观察数据</p> <div class="language-c extra-class"><pre class="language-c"><code><span class="token comment">/* flag 必须定义成全局变量，才能添加到逻辑分析仪中观察波形
** 在逻辑分析仪中要设置为Bit模式才能看到波形，不能使用默认的模拟量
*/</span>
<span class="token class-name">uint32_t</span> flag1<span class="token punctuation">;</span>
<span class="token class-name">uint32_t</span> flag2<span class="token punctuation">;</span>


<span class="token comment">/* 任务1 */</span>
<span class="token keyword">void</span> <span class="token function">Task1</span><span class="token punctuation">(</span> <span class="token keyword">void</span> <span class="token operator">*</span>p_arg <span class="token punctuation">)</span>
<span class="token punctuation">{</span>
     <span class="token keyword">for</span> <span class="token punctuation">(</span> <span class="token punctuation">;</span><span class="token punctuation">;</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
         flag1 <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
         <span class="token function">delay</span><span class="token punctuation">(</span> <span class="token number">100</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
         flag1 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
         <span class="token function">delay</span><span class="token punctuation">(</span> <span class="token number">100</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
 
 <span class="token comment">/* 任务2 */</span>
<span class="token keyword">void</span> <span class="token function">Task2</span><span class="token punctuation">(</span> <span class="token keyword">void</span> <span class="token operator">*</span>p_arg <span class="token punctuation">)</span>
<span class="token punctuation">{</span>
     <span class="token keyword">for</span> <span class="token punctuation">(</span> <span class="token punctuation">;</span><span class="token punctuation">;</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
         flag2 <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
         <span class="token function">delay</span><span class="token punctuation">(</span> <span class="token number">100</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
         flag2 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
         <span class="token function">delay</span><span class="token punctuation">(</span> <span class="token number">100</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="_3-定义任务控制块"><a href="#_3-定义任务控制块" class="header-anchor">#</a> 3.定义任务控制块</h3> <p>任务控制块就相当于任务的身份证，里面存有任务的所 有信息，比如任务的堆栈，任务名称，任务的形参等。有了这个任务控制块之后，以后系 统对任务的全部操作都可以通过这个 <code>TCB</code> 来实现。</p> <p><code>os.h</code> 中定义TCP结构</p> <div class="language-c extra-class"><pre class="language-c"><code><span class="token comment">// os.h</span>
<span class="token keyword">struct</span> <span class="token class-name">os_tcb</span>
<span class="token punctuation">{</span>
	CPU_STK         <span class="token operator">*</span>StkPtr<span class="token punctuation">;</span>
	CPU_STK_SIZE    StkSize<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">typedef</span>  <span class="token keyword">struct</span>  <span class="token class-name">os_tcb</span>  OS_TCB<span class="token punctuation">;</span>
</code></pre></div><p><code>app.c中</code>定义任务TCP</p> <div class="language-c extra-class"><pre class="language-c"><code><span class="token keyword">static</span>   OS_TCB    Task1TCB<span class="token punctuation">;</span>
<span class="token keyword">static</span>   OS_TCB    Task2TCB<span class="token punctuation">;</span>
</code></pre></div><h3 id="_4-实现任务创建函数"><a href="#_4-实现任务创建函数" class="header-anchor">#</a> 4.实现任务创建函数</h3> <p><code>os_task.c</code> 中定义任务创建函数</p> <div class="language-c extra-class"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;os.h&quot;</span></span>

<span class="token keyword">void</span> <span class="token function">OSTaskCreate</span> <span class="token punctuation">(</span>OS_TCB        <span class="token operator">*</span>p_tcb<span class="token punctuation">,</span> 
                   OS_TASK_PTR   p_task<span class="token punctuation">,</span> 
                   <span class="token keyword">void</span>          <span class="token operator">*</span>p_arg<span class="token punctuation">,</span>
                   CPU_STK       <span class="token operator">*</span>p_stk_base<span class="token punctuation">,</span>
                   CPU_STK_SIZE  stk_size<span class="token punctuation">,</span>
                   OS_ERR        <span class="token operator">*</span>p_err<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	CPU_STK       <span class="token operator">*</span>p_sp<span class="token punctuation">;</span>
	
    <span class="token comment">// 返回栈顶指针</span>
	p_sp <span class="token operator">=</span> <span class="token function">OSTaskStkInit</span> <span class="token punctuation">(</span>p_task<span class="token punctuation">,</span>p_arg<span class="token punctuation">,</span>p_stk_base<span class="token punctuation">,</span>stk_size<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
	p_tcb<span class="token operator">-&gt;</span>StkPtr <span class="token operator">=</span> p_sp<span class="token punctuation">;</span>
	p_tcb<span class="token operator">-&gt;</span>StkSize <span class="token operator">=</span> stk_size<span class="token punctuation">;</span>

	<span class="token operator">*</span>p_err <span class="token operator">=</span> OS_ERR_NONE<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p><code>p_tcb</code> 任务控制块</p> <p><code>p_task</code> 任务函数地址，要执行的函数<code>Task1</code>和<code>Task2</code>等</p> <p><code>p_arg</code> 任务形参</p> <p><code>p_stk_base</code> 任务栈起始位置,<code>Task1Stk[0]</code>所在地址</p> <p><code>p_stk_base</code> 任务栈大小</p> <p><code>os.cup_c.c</code> 任务初始化函数</p> <div class="language-c extra-class"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;os.h&quot;</span></span>

<span class="token comment">/* 任务堆栈初始化 */</span>
CPU_STK <span class="token operator">*</span><span class="token function">OSTaskStkInit</span> <span class="token punctuation">(</span>OS_TASK_PTR  p_task<span class="token punctuation">,</span>
                        <span class="token keyword">void</span>         <span class="token operator">*</span>p_arg<span class="token punctuation">,</span>
                        CPU_STK      <span class="token operator">*</span>p_stk_base<span class="token punctuation">,</span>
                        CPU_STK_SIZE stk_size<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	CPU_STK  <span class="token operator">*</span>p_stk<span class="token punctuation">;</span>

	p_stk <span class="token operator">=</span> <span class="token operator">&amp;</span>p_stk_base<span class="token punctuation">[</span>stk_size<span class="token punctuation">]</span><span class="token punctuation">;</span>
															<span class="token comment">/* 异常发生时自动保存的寄存器                              */</span>
	<span class="token operator">*</span><span class="token operator">--</span>p_stk <span class="token operator">=</span> <span class="token punctuation">(</span>CPU_STK<span class="token punctuation">)</span><span class="token number">0x01000000u</span><span class="token punctuation">;</span>                        <span class="token comment">/* xPSR的bit24必须置1                                     */</span>
	<span class="token operator">*</span><span class="token operator">--</span>p_stk <span class="token operator">=</span> <span class="token punctuation">(</span>CPU_STK<span class="token punctuation">)</span>p_task<span class="token punctuation">;</span>                             <span class="token comment">/* 任务的入口地址                                         */</span>
	<span class="token operator">*</span><span class="token operator">--</span>p_stk <span class="token operator">=</span> <span class="token punctuation">(</span>CPU_STK<span class="token punctuation">)</span><span class="token number">0x14141414u</span><span class="token punctuation">;</span>                        <span class="token comment">/* R14 (LR)                                               */</span>
	<span class="token operator">*</span><span class="token operator">--</span>p_stk <span class="token operator">=</span> <span class="token punctuation">(</span>CPU_STK<span class="token punctuation">)</span><span class="token number">0x12121212u</span><span class="token punctuation">;</span>                        <span class="token comment">/* R12                                                    */</span>
	<span class="token operator">*</span><span class="token operator">--</span>p_stk <span class="token operator">=</span> <span class="token punctuation">(</span>CPU_STK<span class="token punctuation">)</span><span class="token number">0x03030303u</span><span class="token punctuation">;</span>                        <span class="token comment">/* R3                                                     */</span>
	<span class="token operator">*</span><span class="token operator">--</span>p_stk <span class="token operator">=</span> <span class="token punctuation">(</span>CPU_STK<span class="token punctuation">)</span><span class="token number">0x02020202u</span><span class="token punctuation">;</span>                        <span class="token comment">/* R2                                                     */</span>
	<span class="token operator">*</span><span class="token operator">--</span>p_stk <span class="token operator">=</span> <span class="token punctuation">(</span>CPU_STK<span class="token punctuation">)</span><span class="token number">0x01010101u</span><span class="token punctuation">;</span>                        <span class="token comment">/* R1                                                     */</span>
	<span class="token operator">*</span><span class="token operator">--</span>p_stk <span class="token operator">=</span> <span class="token punctuation">(</span>CPU_STK<span class="token punctuation">)</span>p_arg<span class="token punctuation">;</span>                              <span class="token comment">/* R0 : 任务形参                                          */</span>
															<span class="token comment">/* 异常发生时需手动保存的寄存器                            */</span>
	<span class="token operator">*</span><span class="token operator">--</span>p_stk <span class="token operator">=</span> <span class="token punctuation">(</span>CPU_STK<span class="token punctuation">)</span><span class="token number">0x11111111u</span><span class="token punctuation">;</span>                        <span class="token comment">/* R11                                                    */</span>
	<span class="token operator">*</span><span class="token operator">--</span>p_stk <span class="token operator">=</span> <span class="token punctuation">(</span>CPU_STK<span class="token punctuation">)</span><span class="token number">0x10101010u</span><span class="token punctuation">;</span>                        <span class="token comment">/* R10                                                    */</span>
	<span class="token operator">*</span><span class="token operator">--</span>p_stk <span class="token operator">=</span> <span class="token punctuation">(</span>CPU_STK<span class="token punctuation">)</span><span class="token number">0x09090909u</span><span class="token punctuation">;</span>                        <span class="token comment">/* R9                                                     */</span>
	<span class="token operator">*</span><span class="token operator">--</span>p_stk <span class="token operator">=</span> <span class="token punctuation">(</span>CPU_STK<span class="token punctuation">)</span><span class="token number">0x08080808u</span><span class="token punctuation">;</span>                        <span class="token comment">/* R8                                                     */</span>
	<span class="token operator">*</span><span class="token operator">--</span>p_stk <span class="token operator">=</span> <span class="token punctuation">(</span>CPU_STK<span class="token punctuation">)</span><span class="token number">0x07070707u</span><span class="token punctuation">;</span>                        <span class="token comment">/* R7                                                     */</span>
	<span class="token operator">*</span><span class="token operator">--</span>p_stk <span class="token operator">=</span> <span class="token punctuation">(</span>CPU_STK<span class="token punctuation">)</span><span class="token number">0x06060606u</span><span class="token punctuation">;</span>                        <span class="token comment">/* R6                                                     */</span>
	<span class="token operator">*</span><span class="token operator">--</span>p_stk <span class="token operator">=</span> <span class="token punctuation">(</span>CPU_STK<span class="token punctuation">)</span><span class="token number">0x05050505u</span><span class="token punctuation">;</span>                        <span class="token comment">/* R5                                                     */</span>
	<span class="token operator">*</span><span class="token operator">--</span>p_stk <span class="token operator">=</span> <span class="token punctuation">(</span>CPU_STK<span class="token punctuation">)</span><span class="token number">0x04040404u</span><span class="token punctuation">;</span>                        <span class="token comment">/* R4                                                     */</span>
	<span class="token keyword">return</span> <span class="token punctuation">(</span>p_stk<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>栈递减的生长方向。</p> <p><img src="/blog/assets/img/image-20240112104850630.02a38598.png" alt="image-20240112104850630"></p> <p>全局变量 OSRDYList 定义</p> <div class="language-c extra-class"><pre class="language-c"><code><span class="token comment">// os_cfg.h</span>
<span class="token comment">/* 支持最大的优先级 */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">OS_CFG_PRIO_MAX</span>                <span class="token expression"><span class="token number">32u</span></span></span>


<span class="token comment">// os.h</span>
<span class="token keyword">struct</span> <span class="token class-name">os_rdy_list</span>
<span class="token punctuation">{</span>
	OS_TCB        <span class="token operator">*</span>HeadPtr<span class="token punctuation">;</span>
	OS_TCB        <span class="token operator">*</span>TailPtr<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">typedef</span>  <span class="token keyword">struct</span>  <span class="token class-name">os_rdy_list</span>         OS_RDY_LIST<span class="token punctuation">;</span>

<span class="token comment">// 外部可访问变量extern</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span>    <span class="token macro-name">OS_EXT</span>  <span class="token expression"><span class="token keyword">extern</span></span></span>

OS_EXT    OS_RDY_LIST    OSRdyList<span class="token punctuation">[</span>OS_CFG_PRIO_MAX<span class="token punctuation">]</span><span class="token punctuation">;</span>
</code></pre></div><p>添加就绪队列</p> <div class="language-c extra-class"><pre class="language-c"><code><span class="token comment">/* 将任务加入到就绪列表 */</span>
OSRdyList<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>HeadPtr <span class="token operator">=</span> <span class="token operator">&amp;</span>Task1TCB<span class="token punctuation">;</span>
OSRdyList<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>HeadPtr <span class="token operator">=</span> <span class="token operator">&amp;</span>Task2TCB<span class="token punctuation">;</span>
</code></pre></div><h2 id="os系统初始化"><a href="#os系统初始化" class="header-anchor">#</a> OS系统初始化</h2> <div class="language-c extra-class"><pre class="language-c"><code><span class="token comment">// cpu.h</span>
<span class="token keyword">typedef</span>  <span class="token keyword">unsigned</span>  <span class="token keyword">char</span>        CPU_INT08U<span class="token punctuation">;</span>

<span class="token comment">// os_type.h</span>
<span class="token keyword">typedef</span>   CPU_INT08U      OS_STATE<span class="token punctuation">;</span>

<span class="token comment">// os.h</span>
OS_EXT    OS_TCB         <span class="token operator">*</span>OSTCBCurPtr<span class="token punctuation">;</span>
OS_EXT    OS_TCB         <span class="token operator">*</span>OSTCBHighRdyPtr<span class="token punctuation">;</span>
OS_EXT    OS_STATE       OSRunning<span class="token punctuation">;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span>  <span class="token macro-name">OS_STATE_OS_STOPPED</span>    <span class="token expression"><span class="token punctuation">(</span>OS_STATE<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">0u</span><span class="token punctuation">)</span></span></span>

<span class="token keyword">struct</span> <span class="token class-name">os_rdy_list</span>
<span class="token punctuation">{</span>
	OS_TCB        <span class="token operator">*</span>HeadPtr<span class="token punctuation">;</span>
	OS_TCB        <span class="token operator">*</span>TailPtr<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">typedef</span>  <span class="token keyword">struct</span>  <span class="token class-name">os_rdy_list</span>         OS_RDY_LIST<span class="token punctuation">;</span>
</code></pre></div><p><code>os_core.c</code> os系统初始化</p> <div class="language-c extra-class"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;os.h&quot;</span></span>

<span class="token comment">/* RTOS初始化
** 初始化全局变量
*/</span>
<span class="token keyword">void</span> <span class="token function">OSInit</span> <span class="token punctuation">(</span>OS_ERR <span class="token operator">*</span>p_err<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	OSRunning <span class="token operator">=</span>  OS_STATE_OS_STOPPED<span class="token punctuation">;</span>
	
	OSTCBCurPtr <span class="token operator">=</span> <span class="token punctuation">(</span>OS_TCB <span class="token operator">*</span><span class="token punctuation">)</span><span class="token number">0</span><span class="token punctuation">;</span>
	OSTCBHighRdyPtr <span class="token operator">=</span> <span class="token punctuation">(</span>OS_TCB <span class="token operator">*</span><span class="token punctuation">)</span><span class="token number">0</span><span class="token punctuation">;</span>
	
    <span class="token comment">// 就绪队列初始化</span>
	<span class="token function">OS_RdyListInit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	
	<span class="token operator">*</span>p_err <span class="token operator">=</span> OS_ERR_NONE<span class="token punctuation">;</span>
<span class="token punctuation">}</span>


<span class="token comment">/* 就绪列表初始化 */</span>
<span class="token keyword">void</span> <span class="token function">OS_RdyListInit</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	OS_PRIO i<span class="token punctuation">;</span>
	OS_RDY_LIST <span class="token operator">*</span>p_rdy_list<span class="token punctuation">;</span>
	
	<span class="token keyword">for</span><span class="token punctuation">(</span> i<span class="token operator">=</span><span class="token number">0u</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span>OS_CFG_PRIO_MAX<span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">)</span>
	<span class="token punctuation">{</span>
		p_rdy_list <span class="token operator">=</span> <span class="token operator">&amp;</span>OSRdyList<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
		p_rdy_list<span class="token operator">-&gt;</span>HeadPtr <span class="token operator">=</span> <span class="token punctuation">(</span>OS_TCB <span class="token operator">*</span><span class="token punctuation">)</span><span class="token number">0</span><span class="token punctuation">;</span>
		p_rdy_list<span class="token operator">-&gt;</span>TailPtr <span class="token operator">=</span> <span class="token punctuation">(</span>OS_TCB <span class="token operator">*</span><span class="token punctuation">)</span><span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>


</code></pre></div><h2 id="启动系统"><a href="#启动系统" class="header-anchor">#</a> 启动系统</h2> <p><code>os_core.c</code> 启动系统</p> <div class="language-c extra-class"><pre class="language-c"><code><span class="token comment">/* 启动RTOS，将不再返回 */</span>
<span class="token keyword">void</span> <span class="token function">OSStart</span> <span class="token punctuation">(</span>OS_ERR <span class="token operator">*</span>p_err<span class="token punctuation">)</span>
<span class="token punctuation">{</span>	
	<span class="token keyword">if</span><span class="token punctuation">(</span> OSRunning <span class="token operator">==</span> OS_STATE_OS_STOPPED <span class="token punctuation">)</span>
	<span class="token punctuation">{</span>
		<span class="token comment">/* 手动配置任务1先运行 */</span>
		OSTCBHighRdyPtr <span class="token operator">=</span> OSRdyList<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>HeadPtr<span class="token punctuation">;</span>
		
		<span class="token comment">/* 启动任务切换，不会返回 */</span>
		<span class="token function">OSStartHighRdy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		
		<span class="token comment">/* 不会运行到这里，运行到这里表示发生了致命的错误 */</span>
		<span class="token operator">*</span>p_err <span class="token operator">=</span> OS_ERR_FATAL_RETURN<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">else</span>
	<span class="token punctuation">{</span>
		<span class="token operator">*</span>p_err <span class="token operator">=</span> OS_STATE_OS_RUNNING<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>OSStartHighRdy() 函数</p> <div class="language-assembly extra-class"><pre class="language-text"><code>;********************************************************************************************************
;                                               常量
;********************************************************************************************************
;--------------------------------------------------------------------------------------------------------
;有关内核外设寄存器定义可参考官方文档：STM32F10xxx Cortex-M3 programming manual
;系统控制块外设SCB地址范围：0xE000ED00-0xE000ED3F
;--------------------------------------------------------------------------------------------------------
NVIC_INT_CTRL   EQU     0xE000ED04                              ; 中断控制及状态寄存器 SCB_ICSR。
NVIC_SYSPRI14   EQU     0xE000ED22                              ; 系统优先级寄存器 SCB_SHPR3：bit16~23
NVIC_PENDSV_PRI EQU           0xFF                              ; PendSV 优先级的值(最低)。
NVIC_PENDSVSET  EQU     0x10000000                              ; 触发PendSV异常的值 Bit28：PENDSVSET。

;********************************************************************************************************
;                                          开始第一次上下文切换
; 1、配置PendSV异常的优先级为最低
; 2、在开始第一次上下文切换之前，设置psp=0
; 3、触发PendSV异常，开始上下文切换
;********************************************************************************************************
OSStartHighRdy
	LDR		R0, = NVIC_SYSPRI14              ; 设置  PendSV 异常优先级为最低
	LDR     R1, = NVIC_PENDSV_PRI
	STRB    R1, [R0]
	
	MOVS    R0, #0                           ; 设置psp的值为0，开始第一次上下文切换
	MSR     PSP, R0
	
	LDR     R0, =NVIC_INT_CTRL               ; 触发PendSV异常
	LDR     R1, =NVIC_PENDSVSET
	STR     R1, [R0]
	
	CPSIE   I                                 ; 开中断
	
OSStartHang
	B       OSStartHang                       ; 程序应永远不会运行到这里	
</code></pre></div><h2 id="任务切换"><a href="#任务切换" class="header-anchor">#</a> 任务切换</h2> <p><code>app.c</code>任务切换<code>OSSched()</code></p> <div class="language-c extra-class"><pre class="language-c"><code><span class="token comment">/* 任务1 */</span>
<span class="token keyword">void</span> <span class="token function">Task1</span><span class="token punctuation">(</span> <span class="token keyword">void</span> <span class="token operator">*</span>p_arg <span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	<span class="token keyword">for</span><span class="token punctuation">(</span> <span class="token punctuation">;</span><span class="token punctuation">;</span> <span class="token punctuation">)</span>
	<span class="token punctuation">{</span>
		flag1 <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
		<span class="token function">delay</span><span class="token punctuation">(</span> <span class="token number">100</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>		
		flag1 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
		<span class="token function">delay</span><span class="token punctuation">(</span> <span class="token number">100</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
		
		<span class="token comment">/* 任务切换，这里是手动切换 */</span>		
		<span class="token function">OSSched</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p><code>OSSched()</code> 任务切换</p> <div class="language-c extra-class"><pre class="language-c"><code><span class="token comment">/* 任务切换，实际就是触发PendSV异常，然后在PendSV异常中进行上下文切换 */</span>
<span class="token keyword">void</span> <span class="token function">OSSched</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span> OSTCBCurPtr <span class="token operator">==</span> OSRdyList<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>HeadPtr <span class="token punctuation">)</span>
	<span class="token punctuation">{</span>
		OSTCBHighRdyPtr <span class="token operator">=</span> OSRdyList<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>HeadPtr<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">else</span>
	<span class="token punctuation">{</span>
		OSTCBHighRdyPtr <span class="token operator">=</span> OSRdyList<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>HeadPtr<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	
	<span class="token function">OS_TASK_SW</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p><code>OS_TASK_SW()</code> 触发中断</p> <div class="language-c extra-class"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span>  <span class="token expression">NVIC_INT_CTRL</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span>  <span class="token macro-name">NVIC_INT_CTRL</span>                      <span class="token expression"><span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span>CPU_REG32 <span class="token operator">*</span><span class="token punctuation">)</span><span class="token number">0xE000ED04</span><span class="token punctuation">)</span>   </span><span class="token comment">/* 中断控制及状态寄存器 SCB_ICSR */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span>  <span class="token expression">NVIC_PENDSVSET</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span>  <span class="token macro-name">NVIC_PENDSVSET</span>                                    <span class="token expression"><span class="token number">0x10000000</span>    </span><span class="token comment">/* 触发PendSV异常的值 Bit28：PENDSVSET */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span>  <span class="token macro-name function">OS_TASK_SW</span><span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">)</span>               NVIC_INT_CTRL <span class="token operator">=</span> NVIC_PENDSVSET</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span>  <span class="token macro-name function">OSIntCtxSw</span><span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">)</span>               NVIC_INT_CTRL <span class="token operator">=</span> NVIC_PENDSVSET</span></span>
</code></pre></div><p><img src="/blog/assets/img/image-20240112113049649.7e57bb56.png" alt="image-20240112113049649"></p> <p>在第28为设置为1悬起PendSV中断</p> <p><strong>PendSV中断处理函数</strong></p> <div class="language-assembly extra-class"><pre class="language-text"><code>;********************************************************************************************************
;                                          PendSVHandler异常
;********************************************************************************************************
PendSV_Handler
; 任务的保存，即把CPU寄存器的值存储到任务的堆栈中	
	CPSID   I                                 ; 关中断，NMI和HardFault除外，防止上下文切换被中断	
	MRS     R0, PSP                           ; 将psp的值加载到R0
	CBZ     R0, OS_CPU_PendSVHandler_nosave   ; 判断R0，如果值为0则跳转到OS_CPU_PendSVHandler_nosave
	                                          ; 进行第一次任务切换的时候，R0肯定为0
	
	; 在进入PendSV异常的时候，当前CPU的xPSR，PC（任务入口地址），R14，R12，R3，R2，R1，R0会自动存储到当前任务堆栈，同时递减PSP的值
	STMDB   R0!, {R4-R11}                     ; 手动存储CPU寄存器R4-R11的值到当前任务的堆栈
	
	LDR     R1, = OSTCBCurPtr                 ; 加载 OSTCBCurPtr 指针的地址到R1，这里LDR属于伪指令
	LDR     R1, [R1]                          ; 加载 OSTCBCurPtr 指针到R1，这里LDR属于ARM指令
	STR     R0, [R1]                          ; 存储R0的值到	OSTCBCurPtr-&gt;OSTCBStkPtr，这个时候R0存的是任务空闲栈的栈顶

; 任务的切换，即把下一个要运行的任务的堆栈内容加载到CPU寄存器中
OS_CPU_PendSVHandler_nosave  
	; OSTCBCurPtr = OSTCBHighRdyPtr;
	LDR     R0, = OSTCBCurPtr                 ; 加载 OSTCBCurPtr 指针的地址到R0，这里LDR属于伪指令
	LDR     R1, = OSTCBHighRdyPtr             ; 加载 OSTCBHighRdyPtr 指针的地址到R1，这里LDR属于伪指令
	LDR     R2, [R1]                          ; 加载 OSTCBHighRdyPtr 指针到R2，这里LDR属于ARM指令
	STR     R2, [R0]                          ; 存储 OSTCBHighRdyPtr 到 OSTCBCurPtr
	
	LDR     R0, [R2]                          ; 加载 OSTCBHighRdyPtr 到 R0
	LDMIA   R0!, {R4-R11}                     ; 加载需要手动保存的信息到CPU寄存器R4-R11
	
	MSR     PSP, R0                           ; 更新PSP的值，这个时候PSP指向下一个要执行的任务的堆栈的栈底（这个栈底已经加上刚刚手动加载到CPU寄存器R4-R11的偏移）
	ORR     LR, LR, #0x04                     ; 确保异常返回使用的堆栈指针是PSP，即LR寄存器的位2要为1
	CPSIE   I                                 ; 开中断
	BX      LR                                ; 异常返回，这个时候任务堆栈中的剩下内容将会自动加载到xPSR，PC（任务入口地址），R14，R12，R3，R2，R1，R0（任务的形参）
	                                          ; 同时PSP的值也将更新，即指向任务堆栈的栈顶。在STM32中，堆栈是由高地址向低地址生长的。
	
	NOP                                       ; 为了汇编指令对齐，不然会有警告
	
	
	END                                       ; 汇编文件结束
</code></pre></div><h2 id="main函数"><a href="#main函数" class="header-anchor">#</a> main函数</h2> <div class="language-c extra-class"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;os.h&quot;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;ARMCM3.h&quot;</span></span>

<span class="token class-name">uint32_t</span> flag1<span class="token punctuation">;</span>
<span class="token class-name">uint32_t</span> flag2<span class="token punctuation">;</span>

<span class="token comment">// TCB &amp; STACK &amp; 任务声明</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span>  <span class="token macro-name">TASK1_STK_SIZE</span>       <span class="token expression"><span class="token number">20</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span>  <span class="token macro-name">TASK2_STK_SIZE</span>       <span class="token expression"><span class="token number">20</span></span></span>

<span class="token keyword">static</span>   CPU_STK   Task1Stk<span class="token punctuation">[</span>TASK1_STK_SIZE<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">static</span>   CPU_STK   Task2Stk<span class="token punctuation">[</span>TASK2_STK_SIZE<span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token keyword">static</span>   OS_TCB    Task1TCB<span class="token punctuation">;</span>
<span class="token keyword">static</span>   OS_TCB    Task2TCB<span class="token punctuation">;</span>

<span class="token keyword">void</span>     <span class="token function">Task1</span><span class="token punctuation">(</span> <span class="token keyword">void</span> <span class="token operator">*</span>p_arg <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span>     <span class="token function">Task2</span><span class="token punctuation">(</span> <span class="token keyword">void</span> <span class="token operator">*</span>p_arg <span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 函数声明</span>
<span class="token keyword">void</span> <span class="token function">delay</span><span class="token punctuation">(</span><span class="token class-name">uint32_t</span> count<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">/*
************************************************************************************************************************
*                                                    main函数
************************************************************************************************************************
*/</span>
<span class="token comment">/*
* 注意事项：1、该工程使用软件仿真，debug需选择 Ude Simulator
*           2、在Target选项卡里面把晶振Xtal(Mhz)的值改为25，默认是12，
*              改成25是为了跟system_ARMCM3.c中定义的__SYSTEM_CLOCK相同，确保仿真的时候时钟一致
*/</span>
<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>	
	OS_ERR err<span class="token punctuation">;</span>
	
	
	
	<span class="token comment">/* 初始化相关的全局变量 */</span>
	<span class="token function">OSInit</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
	
	<span class="token comment">/* 创建任务 */</span>
	<span class="token function">OSTaskCreate</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>OS_TCB<span class="token operator">*</span><span class="token punctuation">)</span>      <span class="token operator">&amp;</span>Task1TCB<span class="token punctuation">,</span> 
	              <span class="token punctuation">(</span>OS_TASK_PTR <span class="token punctuation">)</span> Task1<span class="token punctuation">,</span> 
	              <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span>       <span class="token number">0</span><span class="token punctuation">,</span>
	              <span class="token punctuation">(</span>CPU_STK<span class="token operator">*</span><span class="token punctuation">)</span>     <span class="token operator">&amp;</span>Task1Stk<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
	              <span class="token punctuation">(</span>CPU_STK_SIZE<span class="token punctuation">)</span> TASK1_STK_SIZE<span class="token punctuation">,</span>
	              <span class="token punctuation">(</span>OS_ERR <span class="token operator">*</span><span class="token punctuation">)</span>     <span class="token operator">&amp;</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token function">OSTaskCreate</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>OS_TCB<span class="token operator">*</span><span class="token punctuation">)</span>      <span class="token operator">&amp;</span>Task2TCB<span class="token punctuation">,</span> 
	              <span class="token punctuation">(</span>OS_TASK_PTR <span class="token punctuation">)</span> Task2<span class="token punctuation">,</span> 
	              <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span>       <span class="token number">0</span><span class="token punctuation">,</span>
	              <span class="token punctuation">(</span>CPU_STK<span class="token operator">*</span><span class="token punctuation">)</span>     <span class="token operator">&amp;</span>Task2Stk<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
	              <span class="token punctuation">(</span>CPU_STK_SIZE<span class="token punctuation">)</span> TASK2_STK_SIZE<span class="token punctuation">,</span>
	              <span class="token punctuation">(</span>OS_ERR <span class="token operator">*</span><span class="token punctuation">)</span>     <span class="token operator">&amp;</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
				  
	<span class="token comment">/* 将任务加入到就绪列表 */</span>
	OSRdyList<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>HeadPtr <span class="token operator">=</span> <span class="token operator">&amp;</span>Task1TCB<span class="token punctuation">;</span>
	OSRdyList<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>HeadPtr <span class="token operator">=</span> <span class="token operator">&amp;</span>Task2TCB<span class="token punctuation">;</span>
	
	<span class="token comment">/* 启动OS，将不再返回 */</span>				
	<span class="token function">OSStart</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/*
************************************************************************************************************************
*                                                    函数实现
************************************************************************************************************************
*/</span>
<span class="token comment">/* 软件延时 */</span>
<span class="token keyword">void</span> <span class="token function">delay</span> <span class="token punctuation">(</span><span class="token class-name">uint32_t</span> count<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	<span class="token keyword">for</span><span class="token punctuation">(</span><span class="token punctuation">;</span> count<span class="token operator">!=</span><span class="token number">0</span><span class="token punctuation">;</span> count<span class="token operator">--</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>



<span class="token comment">/* 任务1 */</span>
<span class="token keyword">void</span> <span class="token function">Task1</span><span class="token punctuation">(</span> <span class="token keyword">void</span> <span class="token operator">*</span>p_arg <span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	<span class="token keyword">for</span><span class="token punctuation">(</span> <span class="token punctuation">;</span><span class="token punctuation">;</span> <span class="token punctuation">)</span>
	<span class="token punctuation">{</span>
		flag1 <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
		<span class="token function">delay</span><span class="token punctuation">(</span> <span class="token number">100</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>		
		flag1 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
		<span class="token function">delay</span><span class="token punctuation">(</span> <span class="token number">100</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
		
		<span class="token comment">/* 任务切换，这里是手动切换 */</span>		
		<span class="token function">OSSched</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">/* 任务2 */</span>
<span class="token keyword">void</span> <span class="token function">Task2</span><span class="token punctuation">(</span> <span class="token keyword">void</span> <span class="token operator">*</span>p_arg <span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	<span class="token keyword">for</span><span class="token punctuation">(</span> <span class="token punctuation">;</span><span class="token punctuation">;</span> <span class="token punctuation">)</span>
	<span class="token punctuation">{</span>
		flag2 <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
		<span class="token function">delay</span><span class="token punctuation">(</span> <span class="token number">100</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>		
		flag2 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
		<span class="token function">delay</span><span class="token punctuation">(</span> <span class="token number">100</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
		
		<span class="token comment">/* 任务切换，这里是手动切换 */</span>
		<span class="token function">OSSched</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div></div></section> <footer class="page-edit"><!----> <!----></footer> <!----> <div class="comments-wrapper"><!----></div> <ul class="side-bar sub-sidebar-wrapper" style="width:12rem;" data-v-ac050c62><li class="level-2" data-v-ac050c62><a href="/blog/stm32/2024/0112001.html#创建任务" class="sidebar-link reco-side-创建任务" data-v-ac050c62>创建任务</a></li><li class="level-3" data-v-ac050c62><a href="/blog/stm32/2024/0112001.html#_1-定义任务栈" class="sidebar-link reco-side-_1-定义任务栈" data-v-ac050c62>1.定义任务栈</a></li><li class="level-3" data-v-ac050c62><a href="/blog/stm32/2024/0112001.html#_2-定义任务函数" class="sidebar-link reco-side-_2-定义任务函数" data-v-ac050c62>2.定义任务函数</a></li><li class="level-3" data-v-ac050c62><a href="/blog/stm32/2024/0112001.html#_3-定义任务控制块" class="sidebar-link reco-side-_3-定义任务控制块" data-v-ac050c62>3.定义任务控制块</a></li><li class="level-3" data-v-ac050c62><a href="/blog/stm32/2024/0112001.html#_4-实现任务创建函数" class="sidebar-link reco-side-_4-实现任务创建函数" data-v-ac050c62>4.实现任务创建函数</a></li><li class="level-2" data-v-ac050c62><a href="/blog/stm32/2024/0112001.html#os系统初始化" class="sidebar-link reco-side-os系统初始化" data-v-ac050c62>OS系统初始化</a></li><li class="level-2" data-v-ac050c62><a href="/blog/stm32/2024/0112001.html#启动系统" class="sidebar-link reco-side-启动系统" data-v-ac050c62>启动系统</a></li><li class="level-2" data-v-ac050c62><a href="/blog/stm32/2024/0112001.html#任务切换" class="sidebar-link reco-side-任务切换" data-v-ac050c62>任务切换</a></li><li class="level-2" data-v-ac050c62><a href="/blog/stm32/2024/0112001.html#main函数" class="sidebar-link reco-side-main函数" data-v-ac050c62>main函数</a></li></ul></main></div> <!----></div></div></div></div><div class="global-ui"><div class="back-to-ceiling" style="right:1rem;bottom:6rem;width:2.5rem;height:2.5rem;border-radius:.25rem;line-height:2.5rem;display:none;" data-v-c6073ba8 data-v-c6073ba8><svg t="1574745035067" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="5404" class="icon" data-v-c6073ba8><path d="M526.60727968 10.90185116a27.675 27.675 0 0 0-29.21455937 0c-131.36607665 82.28402758-218.69155461 228.01873535-218.69155402 394.07834331a462.20625001 462.20625001 0 0 0 5.36959153 69.94390903c1.00431239 6.55289093-0.34802892 13.13561351-3.76865779 18.80351572-32.63518765 54.11355614-51.75690182 118.55860487-51.7569018 187.94566865a371.06718723 371.06718723 0 0 0 11.50484808 91.98906777c6.53300375 25.50556257 41.68394495 28.14064038 52.69160883 4.22606766 17.37162448-37.73630017 42.14135425-72.50938081 72.80769204-103.21549295 2.18761121 3.04276886 4.15646224 6.24463696 6.40373557 9.22774369a1871.4375 1871.4375 0 0 0 140.04691725 5.34970492 1866.36093723 1866.36093723 0 0 0 140.04691723-5.34970492c2.24727335-2.98310674 4.21612437-6.18497483 6.3937923-9.2178004 30.66633723 30.70611158 55.4360664 65.4791928 72.80769147 103.21549355 11.00766384 23.91457269 46.15860503 21.27949489 52.69160879-4.22606768a371.15156223 371.15156223 0 0 0 11.514792-91.99901164c0-69.36717486-19.13165746-133.82216804-51.75690182-187.92578088-3.42062944-5.66790279-4.76302748-12.26056868-3.76865837-18.80351632a462.20625001 462.20625001 0 0 0 5.36959269-69.943909c-0.00994388-166.08943902-87.32547796-311.81420293-218.6915546-394.09823051zM605.93803103 357.87693858a93.93749974 93.93749974 0 1 1-187.89594924 6.1e-7 93.93749974 93.93749974 0 0 1 187.89594924-6.1e-7z" p-id="5405" data-v-c6073ba8></path><path d="M429.50777625 765.63860547C429.50777625 803.39355007 466.44236686 1000.39046097 512.00932183 1000.39046097c45.56695499 0 82.4922232-197.00623328 82.5015456-234.7518555 0-37.75494459-36.9345906-68.35043303-82.4922232-68.34111062-45.57627738-0.00932239-82.52019037 30.59548842-82.51086798 68.34111062z" p-id="5406" data-v-c6073ba8></path></svg></div></div></div>
    <script src="/blog/assets/js/app.adc2faba.js" defer></script><script src="/blog/assets/js/6.c7879e8b.js" defer></script><script src="/blog/assets/js/1.6ba5f926.js" defer></script><script src="/blog/assets/js/62.4248028d.js" defer></script>
  </body>
</html>
